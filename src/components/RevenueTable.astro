---
import { platforms } from '../data/platforms/index';
import { revenueTypeLabels } from '../data/types';
import type { RevenueType, MonetizationMethod, Platform } from '../data/types';

interface Props {
  revenueType: RevenueType;
  tableIndex: number;
}

const { revenueType, tableIndex } = Astro.props;
const base = import.meta.env.BASE_URL;
const label = revenueTypeLabels[revenueType];

// Collect all monetization methods of this revenue type across platforms
interface TableRow {
  platform: Platform;
  method: MonetizationMethod;
}

const rows: TableRow[] = [];
platforms.forEach(p => {
  p.monetization.forEach(m => {
    if (m.type === revenueType) {
      rows.push({ platform: p, method: m });
    }
  });
});

// Sort by creatorCutMax descending by default (best for creators first)
rows.sort((a, b) => (b.method.creatorCutMax ?? 0) - (a.method.creatorCutMax ?? 0));

// Helper to determine color for creator cut
function cutColor(val: number | undefined): string {
  if (val === undefined) return 'var(--foreground1)';
  if (val >= 80) return 'var(--green)';
  if (val >= 50) return 'var(--peach)';
  return 'var(--red)';
}

// Helper for entry cost color
function entryCostColor(cost: string | undefined): string {
  if (!cost || cost === '免费') return 'var(--green)';
  return 'var(--peach)';
}

// One-line insight per revenue type (generated from actual data)
const revenueInsights: Record<string, string> = {
  subscription: '微信公众号 0% 抽成最友好；喜马拉雅 60-80% 抽成最重',
  tipping: '微信公众号/知乎赞赏 0% 抽成；快手打赏 70% 到手最高',
  ecommerce: '技术服务费普遍 1-5%，核心差异在商家设定的佣金比例',
  ads: 'B站广告分成 2025 年从 40% 降至 25%，创作激励上限 2000 元/月',
  sponsorship: '小红书蒲公英博主端 0 抽佣，品牌方承担全部服务费',
  course: '小鹅通额度内 0 抽成但需年费；得到邀约制 ~50% 分成',
  newsletter: '小报童 15% 服务费 + ~6% 提现费，实际到手约 79%',
  affiliate: '小报童分销佣金 0 抽成，作者自设比例全额到账',
  'digital-goods': '爱发电仅 6% 抽成；得到电子书 ~70% 到手',
};
const insight = revenueInsights[revenueType] || '';

const tableId = `revenue-table-${tableIndex}`;
---

<div class="revenue-section" style="margin-bottom: 2rem;">
  <h3 style="color: var(--yellow); font-size: 1rem; margin-bottom: 0.25rem; font-family: monospace;">
    $ cat {revenueType}.csv <span style="color: var(--foreground2); font-size: 0.8rem; font-weight: normal; margin-left: 0.5rem;">// {label}</span>
  </h3>
  {insight && (
    <p style="color: var(--foreground2); font-size: 0.78rem; margin: 0 0 0.5rem 0; font-family: monospace;">
      <span style="color: var(--surface2);">// </span>{insight}
    </p>
  )}
  
  <div class="table-wrap">
    <table id={tableId} class="revenue-table" style="width: 100%; font-size: 0.85rem;">
      <thead>
        <tr>
          <th class="sortable" data-sort="name" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            产品 ↕
          </th>
          <th style="white-space: nowrap;">变现方式</th>
          <th class="sortable" data-sort="cut-max" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            创作者到手 ↕
          </th>
          <th style="white-space: nowrap;">抽成</th>
          <th style="white-space: nowrap;">入门成本</th>
          <th style="white-space: nowrap;">备注</th>
          <th class="sortable" data-sort="founded" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            成立 ↕
          </th>
        </tr>
      </thead>
      <tbody>
        {rows.map(({ platform: p, method: m }) => (
          <tr 
            class="revenue-row"
            data-name={p.name}
            data-cut-max={m.creatorCutMax ?? 0}
            data-founded={p.foundedYear || 0}
          >
            <td>
              <a href={`${base}/platform/${p.id}`} style="color: var(--green); font-weight: 500; white-space: nowrap;">
                {p.name}
              </a>
            </td>
            <td style="color: var(--foreground1); font-size: 0.8rem;">{m.name}</td>
            <td style={`color: ${cutColor(m.creatorCutMax)}; white-space: nowrap;`}>
              {m.creatorCut}
            </td>
            <td style="color: var(--foreground2); font-size: 0.8rem;">{m.platformCut}</td>
            <td style={`color: ${entryCostColor(m.entryCost)}; font-size: 0.8rem; white-space: nowrap;`}>
              {m.entryCost || '免费'}
            </td>
            <td style="color: var(--foreground2); font-size: 0.78rem; max-width: 16rem;" class="notes-cell">
              {m.notes || '—'}
            </td>
            <td style="color: var(--foreground2); white-space: nowrap;">{p.foundedYear || '—'}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>
