---
import { platforms } from '../data/platforms/index';
import { revenueTypeLabels } from '../data/types';
import type { RevenueType, MonetizationMethod, Platform } from '../data/types';

interface Props {
  revenueType: RevenueType;
  tableIndex: number;
  region?: 'cn' | 'global' | 'all';
}

const { revenueType, tableIndex, region = 'all' } = Astro.props;
const base = import.meta.env.BASE_URL;
const label = revenueTypeLabels[revenueType];

// Filter platforms by region
const filteredPlatforms = region === 'all' 
  ? platforms 
  : platforms.filter(p => p.region === region);

// Collect all monetization methods of this revenue type across filtered platforms
interface TableRow {
  platform: Platform;
  method: MonetizationMethod;
}

const rows: TableRow[] = [];
filteredPlatforms.forEach(p => {
  p.monetization.forEach(m => {
    if (m.type === revenueType) {
      rows.push({ platform: p, method: m });
    }
  });
});

// Sort by creatorCutMax descending by default (best for creators first)
rows.sort((a, b) => (b.method.creatorCutMax ?? 0) - (a.method.creatorCutMax ?? 0));

// Helper to determine color for creator cut
function cutColor(val: number | undefined): string {
  if (val === undefined) return 'var(--foreground1)';
  if (val >= 80) return 'var(--green)';
  if (val >= 50) return 'var(--peach)';
  return 'var(--red)';
}

// Helper for entry cost color
function entryCostColor(cost: string | undefined): string {
  if (!cost || cost === 'å…è´¹') return 'var(--green)';
  return 'var(--peach)';
}

// Region flag emoji (only shown in 'all' mode)
function regionFlag(p: Platform): string {
  if (region !== 'all') return '';
  return p.region === 'cn' ? 'ğŸ‡¨ğŸ‡³' : 'ğŸŒ';
}

// One-line insight per revenue type
const revenueInsights: Record<string, Record<string, string>> = {
  all: {
    subscription: 'å¾®ä¿¡å…¬ä¼—å· 0% æŠ½æˆæœ€å‹å¥½ï¼›Ghost è‡ªæ‰˜ç®¡ 0% æŠ½æˆï¼›å–œé©¬æ‹‰é›… 60-80% æŠ½æˆæœ€é‡',
    tipping: 'å¾®ä¿¡å…¬ä¼—å·/çŸ¥ä¹/Ko-fi èµèµ 0% æŠ½æˆï¼›å¿«æ‰‹æ‰“èµ 70% åˆ°æ‰‹æœ€é«˜',
    ecommerce: 'æŠ€æœ¯æœåŠ¡è´¹æ™®é 1-5%ï¼Œæ ¸å¿ƒå·®å¼‚åœ¨å•†å®¶è®¾å®šçš„ä½£é‡‘æ¯”ä¾‹',
    ads: 'YouTube é•¿è§†é¢‘ 55% åˆ°æ‰‹ï¼ŒShorts ä»… 45%ï¼›Bç«™å¹¿å‘Šåˆ†æˆä» 40% é™è‡³ 25%',
    sponsorship: 'å°çº¢ä¹¦è’²å…¬è‹±åšä¸»ç«¯ 0 æŠ½ä½£ï¼Œå“ç‰Œæ–¹æ‰¿æ‹…å…¨éƒ¨æœåŠ¡è´¹',
    course: 'å°é¹…é€šé¢åº¦å†… 0 æŠ½æˆä½†éœ€å¹´è´¹ï¼›Teachable å…è´¹ç‰ˆ 10% + äº‹åŠ¡è´¹',
    newsletter: 'Substack 10% æŠ½æˆï¼›å°æŠ¥ç«¥ 15% æœåŠ¡è´¹ + ~6% æç°è´¹',
    affiliate: 'å°æŠ¥ç«¥åˆ†é”€ä½£é‡‘ 0 æŠ½æˆï¼Œä½œè€…è‡ªè®¾æ¯”ä¾‹å…¨é¢åˆ°è´¦',
    'digital-goods': 'çˆ±å‘ç”µä»… 6% æŠ½æˆï¼›Gumroad 10% æŠ½æˆï¼›å¾—åˆ°ç”µå­ä¹¦ ~70% åˆ°æ‰‹',
    crowdfunding: 'çˆ±å‘ç”µä¼—ç­¹ 6% å¹³å°è´¹ï¼Œåˆ›ä½œè€…åˆ°æ‰‹ 94%',
  },
  cn: {
    subscription: 'å¾®ä¿¡å…¬ä¼—å· 0% æŠ½æˆæœ€å‹å¥½ï¼›å–œé©¬æ‹‰é›… 60-80% æŠ½æˆæœ€é‡',
    tipping: 'å¾®ä¿¡å…¬ä¼—å·/çŸ¥ä¹èµèµ 0% æŠ½æˆï¼›å¿«æ‰‹æ‰“èµ 70% åˆ°æ‰‹æœ€é«˜',
    ecommerce: 'æŠ€æœ¯æœåŠ¡è´¹æ™®é 1-5%ï¼Œæ ¸å¿ƒå·®å¼‚åœ¨å•†å®¶è®¾å®šçš„ä½£é‡‘æ¯”ä¾‹',
    ads: 'Bç«™å¹¿å‘Šåˆ†æˆ 2025 å¹´ä» 40% é™è‡³ 25%ï¼Œåˆ›ä½œæ¿€åŠ±ä¸Šé™ 2000 å…ƒ/æœˆ',
    sponsorship: 'å°çº¢ä¹¦è’²å…¬è‹±åšä¸»ç«¯ 0 æŠ½ä½£ï¼Œå“ç‰Œæ–¹æ‰¿æ‹…å…¨éƒ¨æœåŠ¡è´¹',
    course: 'å°é¹…é€šé¢åº¦å†… 0 æŠ½æˆä½†éœ€å¹´è´¹ï¼›å¾—åˆ°é‚€çº¦åˆ¶ ~50% åˆ†æˆ',
    newsletter: 'å°æŠ¥ç«¥ 15% æœåŠ¡è´¹ + ~6% æç°è´¹ï¼Œå®é™…åˆ°æ‰‹çº¦ 79%',
    affiliate: 'å°æŠ¥ç«¥åˆ†é”€ä½£é‡‘ 0 æŠ½æˆï¼Œä½œè€…è‡ªè®¾æ¯”ä¾‹å…¨é¢åˆ°è´¦',
    'digital-goods': 'çˆ±å‘ç”µä»… 6% æŠ½æˆï¼›å¾—åˆ°ç”µå­ä¹¦ ~70% åˆ°æ‰‹',
    crowdfunding: 'çˆ±å‘ç”µä¼—ç­¹ 6% å¹³å°è´¹ï¼Œåˆ›ä½œè€…åˆ°æ‰‹ 94%',
  },
  global: {
    subscription: 'Ghost è‡ªæ‰˜ç®¡ 0% æŠ½æˆï¼›Patreon 2025 å¹´ 8 æœˆèµ·æ–°åˆ›ä½œè€…ç»Ÿä¸€ 10%',
    tipping: 'Ko-fi æ‰“èµ 0% å¹³å°è´¹ï¼ˆå…è´¹ç‰ˆï¼‰ï¼›Buy Me a Coffee æŠ½ 5%',
    ecommerce: 'æŠ€æœ¯æœåŠ¡è´¹æ™®é 1-5%ï¼Œæ ¸å¿ƒå·®å¼‚åœ¨å•†å®¶è®¾å®šçš„ä½£é‡‘æ¯”ä¾‹',
    ads: 'YouTube é•¿è§†é¢‘å¹¿å‘Š 55% åˆ°æ‰‹ï¼ŒShorts ä»… 45%ï¼›TikTok éœ€ 10 ä¸‡ç²‰',
    sponsorship: 'YouTube/TikTok å“ç‰Œåˆä½œç”±åˆ›ä½œè€…è‡ªè¡Œå®šä»·',
    course: 'Teachable å…è´¹ç‰ˆ 10% + $1 äº‹åŠ¡è´¹ï¼›Kajabi å¹´è´¹åˆ¶ 0% æŠ½æˆ',
    newsletter: 'Substack 10% æŠ½æˆï¼›Beehiiv å…è´¹ç‰ˆä¸æŠ½æˆ',
    affiliate: 'Kit æ¨èä½£é‡‘ 0 å¹³å°æŠ½æˆï¼Œåˆ›ä½œè€…å…¨æ‹¿',
    'digital-goods': 'Gumroad 10% æŠ½æˆï¼›Lemon Squeezy 5% + 50Â¢',
    crowdfunding: 'çˆ±å‘ç”µä¼—ç­¹ 6% å¹³å°è´¹ï¼Œåˆ›ä½œè€…åˆ°æ‰‹ 94%',
  },
};
const insight = revenueInsights[region]?.[revenueType] || revenueInsights['all']?.[revenueType] || '';

const tableId = `revenue-table-${region}-${tableIndex}`;
---

{rows.length > 0 && (
<div class="revenue-section" style="margin-bottom: 2rem;">
  <h3 style="color: var(--yellow); font-size: 1rem; margin-bottom: 0.25rem; font-family: monospace;">
    $ cat {revenueType}.csv <span style="color: var(--foreground2); font-size: 0.8rem; font-weight: normal; margin-left: 0.5rem;">// {label}</span>
  </h3>
  {insight && (
    <p style="color: var(--foreground2); font-size: 0.78rem; margin: 0 0 0.5rem 0; font-family: monospace;">
      <span style="color: var(--surface2);">// </span>{insight}
    </p>
  )}
  
  <div class="table-wrap">
    <table id={tableId} class="revenue-table" style="width: 100%; font-size: 0.85rem;">
      <thead>
        <tr>
          <th class="sortable" data-sort="name" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            äº§å“ â†•
          </th>
          <th style="white-space: nowrap;">å˜ç°æ–¹å¼</th>
          <th class="sortable" data-sort="cut-max" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            åˆ›ä½œè€…åˆ°æ‰‹ â†•
          </th>
          <th style="white-space: nowrap;">æŠ½æˆ</th>
          <th style="white-space: nowrap;">å…¥é—¨æˆæœ¬</th>
          <th style="white-space: nowrap;">å¤‡æ³¨</th>
          <th class="sortable" data-sort="founded" data-table={tableId} style="cursor: pointer; white-space: nowrap;">
            æˆç«‹ â†•
          </th>
        </tr>
      </thead>
      <tbody>
        {rows.map(({ platform: p, method: m }) => (
          <tr 
            class="revenue-row"
            data-name={p.name}
            data-cut-max={m.creatorCutMax ?? 0}
            data-founded={p.foundedYear || 0}
          >
            <td>
              <a href={`${base}/platform/${p.id}`} style="color: var(--green); font-weight: 500; white-space: nowrap;">
                {region === 'all' && (
                  <span style="font-size: 0.75rem; margin-right: 0.2rem;">{regionFlag(p)}</span>
                )}
                {p.name}
              </a>
            </td>
            <td style="color: var(--foreground1); font-size: 0.8rem;">{m.name}</td>
            <td style={`color: ${cutColor(m.creatorCutMax)}; white-space: nowrap;`}>
              {m.creatorCut}
            </td>
            <td style="color: var(--foreground2); font-size: 0.8rem;">{m.platformCut}</td>
            <td style={`color: ${entryCostColor(m.entryCost)}; font-size: 0.8rem; white-space: nowrap;`}>
              {m.entryCost || 'å…è´¹'}
            </td>
            <td style="color: var(--foreground2); font-size: 0.78rem; max-width: 16rem;" class="notes-cell">
              {m.notes || 'â€”'}
            </td>
            <td style="color: var(--foreground2); white-space: nowrap;">{p.foundedYear || 'â€”'}</td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</div>
)}
