---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import RevenueTable from '../components/RevenueTable.astro';
import { platforms } from '../data/platforms/index';
import { revenueTypeLabels } from '../data/types';
import type { RevenueType } from '../data/types';

// Revenue types in display order
const revenueTypeOrder: RevenueType[] = [
  'subscription',
  'tipping',
  'ecommerce',
  'ads',
  'sponsorship',
  'course',
  'newsletter',
  'affiliate',
  'crowdfunding',
  'digital-goods',
];

// Collect all revenue types that actually have data
const activeRevenueTypes = revenueTypeOrder.filter(rt =>
  platforms.some(p => p.monetization.some(m => m.type === rt))
);

// Count total monetization methods
const totalMethods = platforms.reduce((sum, p) => sum + p.monetization.length, 0);

// Region counts
const cnPlatforms = platforms.filter(p => p.region === 'cn');
const globalPlatforms = platforms.filter(p => p.region === 'global');
const cnCount = cnPlatforms.length;
const globalCount = globalPlatforms.length;
const cnMethods = cnPlatforms.reduce((sum, p) => sum + p.monetization.length, 0);
const globalMethods = globalPlatforms.reduce((sum, p) => sum + p.monetization.length, 0);

// Active revenue types per region
const activeRevenueTypesCn = revenueTypeOrder.filter(rt =>
  cnPlatforms.some(p => p.monetization.some(m => m.type === rt))
);
const activeRevenueTypesGlobal = revenueTypeOrder.filter(rt =>
  globalPlatforms.some(p => p.monetization.some(m => m.type === rt))
);
---

<Layout>
  <Header />
  
  <main>
    <!-- Hero -->
    <section class="py-4 text-center">
      <h1 style="color: var(--green); font-size: 2.5rem; margin-bottom: 0.5rem;">
        &gt; CreatorCut_
      </h1>
      <p style="color: var(--foreground1); font-size: 1.1rem; max-width: 40rem; margin: 0 auto;">
        åˆ›ä½œè€…åˆ†æˆæ•°æ®åº“ â€” ç³»ç»Ÿæ•´ç†å…¨çƒå†…å®¹äº§å“çš„å˜ç°æ–¹å¼ã€åˆ†æˆæ¯”ä¾‹ã€å…¥é©»é—¨æ§›
      </p>
      <p style="color: var(--foreground2); font-size: 0.85rem; margin-top: 0.5rem;">
        æ•°æ®ä¸ºç‹ï¼Œæ¥æºé€æ˜ï¼Œä¿æŒä¸­ç«‹ã€‚è¦†ç›–ä¸­å›½ + æµ·å¤–ä¸»æµåˆ›ä½œè€…äº§å“ï¼Œå¸®åŠ©åˆ›ä½œè€…åšå‡ºæ›´æ˜æ™ºçš„é€‰æ‹©ã€‚
      </p>
      <p id="coverage-text" style="color: var(--sky); font-size: 0.85rem; margin-top: 0.5rem;">
        è¦†ç›– {platforms.length} ä¸ªäº§å“ï¼Œ{totalMethods} ç§å˜ç°æ–¹å¼
      </p>
    </section>

    <!-- Key findings -->
    <section class="mb-3">
      <div is-="box" style="padding: 1rem;">
        <h2 style="color: var(--yellow); font-size: 1rem; margin-top: 0; margin-bottom: 0.75rem;">
          $ cat key-findings.txt
        </h2>
        <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85rem; color: var(--foreground1);">
          <li style="margin-bottom: 0.3rem;">â†’ å¾®ä¿¡å…¬ä¼—å·ä»˜è´¹é˜…è¯»/èµèµ <span style="color: var(--green);">0% æŠ½æˆ</span>ï¼Œåˆ›ä½œè€…å…¨æ‹¿ï¼›çˆ±å‘ç”µä»… <span style="color: var(--green);">6% æŠ½æˆ</span>ï¼Œå…¨åº“æœ€ä½</li>
          <li style="margin-bottom: 0.3rem;">â†’ å°çº¢ä¹¦è’²å…¬è‹±å•†å• <span style="color: var(--green);">åšä¸»ç«¯ 0 æŠ½ä½£</span>ï¼ˆå“ç‰Œæ–¹ä»˜è´¹ï¼‰ï¼Œè¡Œä¸šç‹¬ä¸€æ— äºŒ</li>
          <li style="margin-bottom: 0.3rem;">â†’ å°é¹…é€šé¢åº¦å†… <span style="color: var(--green);">0 æŠ½æˆ</span>ï¼Œä½†éœ€å¹´è´¹ 6,800-25,800 å…ƒï¼›çŸ¥è¯†æ˜Ÿçƒä¼ä¸šç‰ˆä»… <span style="color: var(--green);">5-10%</span></li>
          <li style="margin-bottom: 0.3rem;">â†’ å–œé©¬æ‹‰é›…ä»˜è´¹ä¸“è¾‘åˆ›ä½œè€…ä»…æ‹¿ <span style="color: var(--red);">20-40%</span>ï¼Œ15 ä¸ªä¸­å›½äº§å“ä¸­åˆ†æˆæœ€ä½</li>
          <li style="margin-bottom: 0.3rem;">â†’ B ç«™å¹¿å‘Šåˆ†æˆä» 40% <span style="color: var(--red);">é™è‡³ 25%</span>ï¼›å°æŠ¥ç«¥å®é™…åˆ°æ‰‹ ~79%ï¼ˆ15% æœåŠ¡è´¹ + ~6% æç°è´¹ï¼‰</li>
          <li style="margin-bottom: 0.5rem; border-top: 1px solid var(--surface1); padding-top: 0.5rem; color: var(--sky); font-size: 0.8rem;">ğŸŒ æµ·å¤–äº§å“</li>
          <li style="margin-bottom: 0.3rem;">â†’ Ko-fi æ‰“èµ <span style="color: var(--green);">0% å¹³å°è´¹</span>ï¼ˆå…è´¹ç‰ˆï¼‰ï¼ŒGhost è‡ªæ‰˜ç®¡ <span style="color: var(--green);">0% æŠ½æˆ</span></li>
          <li style="margin-bottom: 0.3rem;">â†’ YouTube é•¿è§†é¢‘å¹¿å‘Š <span style="color: var(--green);">55% åˆ°æ‰‹</span>ï¼ŒShorts ä»… <span style="color: var(--peach);">45%</span></li>
          <li style="margin-bottom: 0.3rem;">â†’ Patreon 2025 å¹´ 8 æœˆèµ·æ–°åˆ›ä½œè€…ç»Ÿä¸€ <span style="color: var(--peach);">10% å¹³å°è´¹</span></li>
          <li style="margin-bottom: 0.3rem;">â†’ Apple Podcasts è®¢é˜…é¦–å¹´ <span style="color: var(--red);">30% æŠ½æˆ</span>ï¼Œæ¬¡å¹´é™è‡³ <span style="color: var(--peach);">15%</span></li>
          <li style="margin-bottom: 0.3rem;">â†’ è¦†ç›– <span style="color: var(--sky);">{platforms.length} ä¸ªäº§å“ï¼ˆ{cnCount} ğŸ‡¨ğŸ‡³ + {globalCount} ğŸŒï¼‰ã€{totalMethods} ç§å˜ç°æ–¹å¼</span>ï¼Œæ•°æ®å…¨éƒ¨æ ‡æ³¨æ¥æº</li>
        </ul>
      </div>
    </section>

    <!-- Revenue type tables -->
    <section>
      <h2 style="color: var(--foreground0); font-size: 1.1rem; margin-bottom: 1rem;">
        $ ls --group-by=revenue_type
      </h2>

      <!-- Region filter tabs -->
      <div class="flex flex-wrap gap-1 mb-2" style="align-items: center;">
        <span style="color: var(--foreground2); font-size: 0.85rem;">åœ°åŒºï¼š</span>
        <button
          class="region-tab active"
          data-region="all"
          style="font-size: 0.8rem; padding: 0.3rem 0.75rem; border: 1px solid var(--green); color: var(--base); background: var(--green); cursor: pointer; font-family: inherit; transition: all 0.15s;"
        >
          å…¨éƒ¨ ({platforms.length})
        </button>
        <button
          class="region-tab"
          data-region="cn"
          style="font-size: 0.8rem; padding: 0.3rem 0.75rem; border: 1px solid var(--surface1); color: var(--foreground1); background: none; cursor: pointer; font-family: inherit; transition: all 0.15s;"
        >
          ğŸ‡¨ğŸ‡³ ä¸­å›½ ({cnCount})
        </button>
        <button
          class="region-tab"
          data-region="global"
          style="font-size: 0.8rem; padding: 0.3rem 0.75rem; border: 1px solid var(--surface1); color: var(--foreground1); background: none; cursor: pointer; font-family: inherit; transition: all 0.15s;"
        >
          ğŸŒ æµ·å¤– ({globalCount})
        </button>
      </div>

      <!-- Quick nav (per region) -->
      <div id="nav-all" class="region-content flex flex-wrap gap-1 mb-3" data-region="all" style="align-items: center;">
        <span style="color: var(--foreground2); font-size: 0.85rem;">è·³è½¬ï¼š</span>
        {activeRevenueTypes.map(rt => (
          <a 
            href={`#rt-all-${rt}`}
            style="font-size: 0.75rem; padding: 0.2rem 0.5rem; border: 1px solid var(--surface1); color: var(--foreground1); text-decoration: none; border-radius: 2px;"
            class="nav-btn"
          >
            {revenueTypeLabels[rt]}
          </a>
        ))}
      </div>
      <div id="nav-cn" class="region-content flex flex-wrap gap-1 mb-3" data-region="cn" style="align-items: center; display: none;">
        <span style="color: var(--foreground2); font-size: 0.85rem;">è·³è½¬ï¼š</span>
        {activeRevenueTypesCn.map(rt => (
          <a 
            href={`#rt-cn-${rt}`}
            style="font-size: 0.75rem; padding: 0.2rem 0.5rem; border: 1px solid var(--surface1); color: var(--foreground1); text-decoration: none; border-radius: 2px;"
            class="nav-btn"
          >
            {revenueTypeLabels[rt]}
          </a>
        ))}
      </div>
      <div id="nav-global" class="region-content flex flex-wrap gap-1 mb-3" data-region="global" style="align-items: center; display: none;">
        <span style="color: var(--foreground2); font-size: 0.85rem;">è·³è½¬ï¼š</span>
        {activeRevenueTypesGlobal.map(rt => (
          <a 
            href={`#rt-global-${rt}`}
            style="font-size: 0.75rem; padding: 0.2rem 0.5rem; border: 1px solid var(--surface1); color: var(--foreground1); text-decoration: none; border-radius: 2px;"
            class="nav-btn"
          >
            {revenueTypeLabels[rt]}
          </a>
        ))}
      </div>

      <!-- All platforms tables -->
      <div id="tables-all" class="region-content" data-region="all">
        {activeRevenueTypes.map((rt, i) => (
          <div id={`rt-all-${rt}`}>
            <RevenueTable revenueType={rt} tableIndex={i} region="all" />
          </div>
        ))}
      </div>

      <!-- CN platforms tables -->
      <div id="tables-cn" class="region-content" data-region="cn" style="display: none;">
        {activeRevenueTypesCn.map((rt, i) => (
          <div id={`rt-cn-${rt}`}>
            <RevenueTable revenueType={rt} tableIndex={i} region="cn" />
          </div>
        ))}
      </div>

      <!-- Global platforms tables -->
      <div id="tables-global" class="region-content" data-region="global" style="display: none;">
        {activeRevenueTypesGlobal.map((rt, i) => (
          <div id={`rt-global-${rt}`}>
            <RevenueTable revenueType={rt} tableIndex={i} region="global" />
          </div>
        ))}
      </div>

      <p style="color: var(--foreground2); font-size: 0.8rem; margin-top: 0.75rem;">
        * æ‰€æœ‰åˆ†æˆæ¯”ä¾‹å‡ä¸ºç¨å‰ï¼ˆä¸å«ç¨ï¼‰ã€‚ç‚¹å‡»è¡¨å¤´å¯æ’åºï¼Œç‚¹å‡»äº§å“åç§°æŸ¥çœ‹è¯¦æƒ…ã€‚
      </p>
    </section>
  </main>

  <Footer />
</Layout>

<script define:vars={{ totalMethods, cnCount, globalCount, cnMethods, globalMethods, totalPlatforms: platforms.length }}>
  // Region tab switching
  const regionTabs = document.querySelectorAll('.region-tab');
  const regionContents = document.querySelectorAll('.region-content');
  const coverageText = document.getElementById('coverage-text');

  const coverageMap = {
    all: `è¦†ç›– ${totalPlatforms} ä¸ªäº§å“ï¼Œ${totalMethods} ç§å˜ç°æ–¹å¼`,
    cn: `è¦†ç›– ${cnCount} ä¸ªä¸­å›½äº§å“ï¼Œ${cnMethods} ç§å˜ç°æ–¹å¼`,
    global: `è¦†ç›– ${globalCount} ä¸ªæµ·å¤–äº§å“ï¼Œ${globalMethods - 0} ç§å˜ç°æ–¹å¼`,
  };

  regionTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const region = tab.getAttribute('data-region');
      
      // Update tab styles
      regionTabs.forEach(t => {
        t.style.border = '1px solid var(--surface1)';
        t.style.color = 'var(--foreground1)';
        t.style.background = 'none';
      });
      tab.style.border = '1px solid var(--green)';
      tab.style.color = 'var(--base)';
      tab.style.background = 'var(--green)';
      
      // Show/hide content
      regionContents.forEach(el => {
        el.style.display = el.getAttribute('data-region') === region ? '' : 'none';
      });

      // Update coverage text
      coverageText.textContent = coverageMap[region] || coverageMap.all;
    });
  });
</script>

<script>
  // Sort logic for all revenue tables
  let sortDir: Record<string, boolean> = {};
  
  document.querySelectorAll('.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const sortKey = th.getAttribute('data-sort')!;
      const tableId = th.getAttribute('data-table')!;
      const dirKey = `${tableId}-${sortKey}`;
      sortDir[dirKey] = !sortDir[dirKey];
      const asc = sortDir[dirKey];
      
      const tbody = document.querySelector(`#${tableId} tbody`);
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('.revenue-row'));
      
      rows.sort((a, b) => {
        let valA: string | number, valB: string | number;
        if (sortKey === 'name') {
          valA = a.getAttribute('data-name') || '';
          valB = b.getAttribute('data-name') || '';
          return asc ? valA.localeCompare(valB, 'zh-CN') : valB.localeCompare(valA, 'zh-CN');
        } else if (sortKey === 'cut-max') {
          valA = parseFloat(a.getAttribute('data-cut-max') || '0');
          valB = parseFloat(b.getAttribute('data-cut-max') || '0');
        } else if (sortKey === 'founded') {
          valA = parseFloat(a.getAttribute('data-founded') || '0');
          valB = parseFloat(b.getAttribute('data-founded') || '0');
        } else {
          valA = 0;
          valB = 0;
        }
        return asc ? (valA as number) - (valB as number) : (valB as number) - (valA as number);
      });
      
      rows.forEach(row => tbody.appendChild(row));
    });
  });
</script>

<style is:global>
  .nav-btn:hover {
    border-color: var(--green) !important;
    color: var(--green) !important;
  }
  .region-tab:hover {
    border-color: var(--green) !important;
    color: var(--green) !important;
  }
  .sortable:hover {
    color: var(--sky);
  }
  .notes-cell {
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .revenue-table th {
    text-align: left;
    padding: 0.4rem 0.5rem;
    border-bottom: 1px solid var(--surface1);
  }
  .revenue-table td {
    padding: 0.4rem 0.5rem;
    border-bottom: 1px solid var(--surface0);
  }
  .revenue-table tr:hover td {
    background: var(--surface0);
  }
</style>
